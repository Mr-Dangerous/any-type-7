# Fleet Upgrades System - Global Progression

## Overview

**Fleet Upgrades** are passive bonuses that affect the entire fleet and **Colony Ship**, providing global benefits during a run. Unlike **upgrade relics** (which equip to individual ships) and **weapons** (active equipment), fleet upgrades enhance sector exploration capabilities, resource generation, and fleet-wide combat performance.

**Key Characteristics**:
- **Not equipped to ships**: Apply globally to the entire fleet/Colony Ship
- **Per-run progression**: Acquired during a run, reset when you die or complete the game
- **Stackable**: Can acquire multiple copies of the same upgrade for cumulative bonuses
- **Four bonus categories**: Sector exploration, global combat, resource generation, special abilities

---

## Acquisition Methods

### 1. Purchase (Traders)
- Available at Trader nodes in sectors
- Cost: Metal and/or Crystals (typically more expensive than relics)
- Shop inventory randomized per trader
- Limited stock (1-3 fleet upgrades per trader)

### 2. Found (Exploration)
- **Artifact Vaults**: 30% chance to contain a fleet upgrade
- **Ship Graveyards**: 15% chance to find a fleet upgrade when salvaging
- **Special Nodes**: Rare "Derelict Outpost" nodes guarantee 1 fleet upgrade
- **Mothership Boss**: Defeating the mothership drops 2-3 fleet upgrades

### 3. Earned (Milestones)
Automatically granted when achieving run objectives:
- **First Blood**: Destroy first enemy ship → Unlock choice of 1 fleet upgrade
- **Sector Cleared**: Complete a sector (find exit) → Choose 1 fleet upgrade
- **Perfect Combat**: Win combat without losing a ship → 50% chance for fleet upgrade
- **Colony Destroyed**: Destroy an Alien Colony → Choose 1 fleet upgrade
- **Boss Defeated**: Defeat sector mothership → Choose 2 fleet upgrades

---

## Bonus Categories

### Category 1: Sector Exploration Bonuses

Enhance navigation, fuel efficiency, and map interaction.

#### **Enhanced Gravity Assist**
**Effect**: Gravity Assist grants +0.3 speed per use (instead of +0.2)
**Stackable**: Yes (each stack adds +0.1, e.g., 2 stacks = +0.4 per use)
**Acquisition**: Traders, Vaults (common)
**Flavor**: "Mastery of orbital mechanics"

#### **Fuel Efficiency**
**Effect**: Jumping costs 8 fuel instead of 10
**Stackable**: Yes (each stack reduces by 1, minimum 5 fuel)
**Acquisition**: Traders, Milestones (common)
**Flavor**: "Optimized jump calculations"

#### **Extended Sensors**
**Effect**: Fog of war reveal radius increased by +50px
**Stackable**: Yes (each stack adds +50px)
**Acquisition**: Vaults, Graveyards (uncommon)
**Flavor**: "Long-range scanning array"

#### **Swift Navigation**
**Effect**: Base Colony Ship movement speed +20%
**Stackable**: Yes (additive)
**Acquisition**: Traders (common)
**Flavor**: "Upgraded sublight engines"

#### **Deep Scan**
**Effect**: Nodes within 500px reveal their type (Mining, Outpost, etc.) before visiting
**Stackable**: No (unique effect)
**Acquisition**: Vaults (rare)
**Flavor**: "Predictive analytics suite"

#### **Emergency Jump**
**Effect**: Once per sector, jump for free (0 fuel cost)
**Stackable**: Yes (gain +1 free jump per stack)
**Acquisition**: Milestones (uncommon)
**Flavor**: "Capacitor reserves"

#### **Gravity Well Detection**
**Effect**: Automatically highlight gravitationally significant bodies for gravity assist
**Stackable**: No (unique utility)
**Acquisition**: Traders (common)
**Flavor**: "Gravitational mapping"

---

### Category 2: Global Combat Bonuses

Apply to ALL ships in the fleet during combat.

#### **Fleet Cohesion**
**Effect**: All ships gain +5% Attack Speed
**Stackable**: Yes (additive)
**Acquisition**: Milestones, Traders (common)
**Flavor**: "Synchronized firing protocols"

#### **Reinforced Fleet**
**Effect**: All ships gain +25 Hull Points
**Stackable**: Yes (additive)
**Acquisition**: Traders, Graveyards (common)
**Flavor**: "Fleet-wide armor plating"

#### **Shield Harmonics**
**Effect**: All ships gain +20 Shield Points
**Stackable**: Yes (additive)
**Acquisition**: Traders (common)
**Flavor**: "Unified shield frequency"

#### **Precision Training**
**Effect**: All ships gain +5% Precision (crit chance)
**Stackable**: Yes (additive)
**Acquisition**: Milestones (uncommon)
**Flavor**: "Advanced targeting drills"

#### **Evasive Maneuvers**
**Effect**: All ships gain +5% Evasion
**Stackable**: Yes (additive)
**Acquisition**: Traders (uncommon)
**Flavor**: "Unpredictable flight patterns"

#### **Overcharged Weapons**
**Effect**: All ships gain +10% Attack Damage
**Stackable**: Yes (additive)
**Acquisition**: Milestones, Traders (uncommon)
**Flavor**: "Weapon power surplus"

#### **Energy Reserves**
**Effect**: All ships start combat with +25 energy
**Stackable**: Yes (additive)
**Acquisition**: Vaults (uncommon)
**Flavor**: "Pre-charged capacitors"

#### **Rapid Deployment**
**Effect**: All ships gain +15% Movement Speed during combat
**Stackable**: Yes (additive)
**Acquisition**: Traders (common)
**Flavor**: "Combat thrusters"

#### **Second Wind**
**Effect**: All ships regenerate 10% of max shields when an enemy wave is cleared
**Stackable**: Yes (each stack adds +10% regen)
**Acquisition**: Milestones (rare)
**Flavor**: "Adaptive recovery systems"

---

### Category 3: Resource Generation Bonuses

Increase Metal, Crystal, and Fuel acquisition.

#### **Mining Efficiency**
**Effect**: Mining nodes yield +20% resources
**Stackable**: Yes (additive)
**Acquisition**: Traders (common)
**Flavor**: "Enhanced extraction algorithms"

#### **Salvage Expertise**
**Effect**: Graveyards and destroyed enemies drop +15% Metal
**Stackable**: Yes (additive)
**Acquisition**: Graveyards, Milestones (common)
**Flavor**: "Expert scrappers"

#### **Crystalline Affinity**
**Effect**: All Crystal sources yield +25% Crystals
**Stackable**: Yes (additive)
**Acquisition**: Vaults (uncommon)
**Flavor**: "Resonance tuning"

#### **Fuel Synthesizer**
**Effect**: Gain +2 Fuel per combat victory
**Stackable**: Yes (additive)
**Acquisition**: Traders (uncommon)
**Flavor**: "Debris-to-fuel converter"

#### **Resource Cache**
**Effect**: Start each sector with +50 Metal and +25 Crystals
**Stackable**: Yes (additive)
**Acquisition**: Milestones (rare)
**Flavor**: "Emergency reserves"

#### **Efficient Looting**
**Effect**: Outpost nodes grant +30% resources
**Stackable**: Yes (additive)
**Acquisition**: Traders (common)
**Flavor**: "Rapid salvage teams"

#### **Prospector Drones**
**Effect**: 10% chance to find random resources when jumping
**Stackable**: Yes (each stack adds +10% chance)
**Acquisition**: Vaults (rare)
**Flavor**: "Automated resource scanning"

---

### Category 4: Special Abilities

Unlock unique mechanics or powerful one-time effects.

#### **Orbital Strike**
**Effect**: Once per combat, call down an orbital bombardment (100 damage, 5x5 area)
**Stackable**: Yes (gain +1 use per stack)
**Acquisition**: Milestones, Mothership Boss (rare)
**Flavor**: "Colony Ship weapons online"

#### **Emergency Repair**
**Effect**: Once per sector, fully repair all ship hull and shields
**Stackable**: Yes (gain +1 use per stack)
**Acquisition**: Vaults (rare)
**Flavor**: "Rapid nanite repair swarm"

#### **Tactical Retreat Mastery**
**Effect**: Retreat countdown reduced from 30s to 20s
**Stackable**: Yes (each stack reduces by 5s, minimum 10s)
**Acquisition**: Milestones (uncommon)
**Flavor**: "Optimized jump sequence"

#### **Automated Defense**
**Effect**: Deploy 1 Defense Drone at combat start (attacks enemies automatically)
**Stackable**: Yes (each stack adds +1 drone)
**Acquisition**: Vaults, Graveyards (rare)
**Flavor**: "AI guardian fleet"

#### **Shield Overload**
**Effect**: Once per combat, instantly restore all shields to full
**Stackable**: Yes (gain +1 use per stack)
**Acquisition**: Vaults (rare)
**Flavor**: "Emergency capacitor dump"

#### **Sensor Jamming**
**Effect**: First enemy wave in combat spawns 20% slower
**Stackable**: Yes (each stack adds +10% delay)
**Acquisition**: Vaults (uncommon)
**Flavor**: "Electronic countermeasures"

#### **Colony Ship Barrage**
**Effect**: Every 30 seconds in combat, Colony Ship fires a volley (50 damage to random enemies)
**Stackable**: Yes (reduces cooldown by 5s per stack)
**Acquisition**: Mothership Boss (epic)
**Flavor**: "Long-range artillery support"

#### **Escape Pod Protocol**
**Effect**: When a ship is destroyed, 50% chance it ejects and returns after combat (no rewards)
**Stackable**: Yes (each stack adds +10% chance, max 90%)
**Acquisition**: Graveyards (rare)
**Flavor**: "Last-ditch survival"

#### **Combat Scavenger**
**Effect**: Destroyed enemies have 15% chance to drop a powerup
**Stackable**: Yes (each stack adds +5%)
**Acquisition**: Milestones (uncommon)
**Flavor**: "Rapid salvage protocols"

#### **Advanced Logistics**
**Effect**: Can equip 1 additional Tier 2 relic per ship (7 slots instead of 6)
**Stackable**: No (unique, extremely powerful)
**Acquisition**: Mothership Boss (legendary)
**Flavor**: "Expanded equipment hardpoints"

---

## Fleet Upgrade Tiers (Rarity)

Fleet upgrades have rarity tiers that affect their drop rates and power level:

| Rarity | Drop Rate | Power Level | Examples |
|--------|-----------|-------------|----------|
| **Common** | 60% | Small bonuses | Fuel Efficiency, Mining Efficiency, Fleet Cohesion |
| **Uncommon** | 25% | Medium bonuses | Extended Sensors, Precision Training, Salvage Expertise |
| **Rare** | 12% | Large bonuses | Deep Scan, Second Wind, Orbital Strike |
| **Epic** | 2.5% | Very powerful | Colony Ship Barrage, Resource Cache |
| **Legendary** | 0.5% | Game-changing | Advanced Logistics (7 relic slots) |

---

## Stacking Mechanics

Most fleet upgrades are **stackable**, meaning acquiring multiple copies increases the effect:

**Additive Stacking** (most common):
- 1st Stack: +5% Attack Speed
- 2nd Stack: +10% Attack Speed (total)
- 3rd Stack: +15% Attack Speed (total)

**Per-Stack Bonuses**:
- Some upgrades grant additional uses (e.g., Orbital Strike: +1 use per stack)
- Others reduce cooldowns (e.g., Colony Ship Barrage: -5s per stack)

**Unique Effects** (cannot stack):
- Deep Scan, Gravity Well Detection, Advanced Logistics
- Acquiring a duplicate grants a small resource refund (50 Metal + 25 Crystals)

---

## Acquisition Balance

### Expected Fleet Upgrades Per Run

**Conservative Run** (avoid risky nodes):
- Sector completions: 5-8 upgrades (1 per sector milestone)
- Traders: 2-4 upgrades (if you have resources)
- **Total**: 7-12 fleet upgrades

**Aggressive Run** (clear Vaults, Colonies, Graveyards):
- Sector completions: 5-8 upgrades
- Traders: 3-5 upgrades
- Exploration finds: 3-6 upgrades (Vaults, Graveyards)
- Milestones: 2-4 upgrades (Colony destruction, Perfect Combat)
- **Total**: 13-23 fleet upgrades

**Mothership Kill** (late-game power spike):
- +2-3 fleet upgrades from boss drop
- Likely 15-25 total upgrades by endgame

---

## Strategic Considerations

### Build Archetypes

**1. Explorer Build** (Sector Exploration focus)
- Stack: Fuel Efficiency, Enhanced Gravity Assist, Extended Sensors
- Goal: Maximize map coverage with minimal fuel usage
- Synergy: Deep Scan reveals valuable nodes early

**2. Combat Juggernaut** (Global Combat focus)
- Stack: Reinforced Fleet, Fleet Cohesion, Overcharged Weapons
- Goal: Brute force through encounters with raw stats
- Synergy: Second Wind provides sustain between waves

**3. Economy Build** (Resource Generation focus)
- Stack: Mining Efficiency, Salvage Expertise, Fuel Synthesizer
- Goal: Maximize resource income to buy relics/weapons from traders
- Synergy: Resource Cache front-loads each sector

**4. Special Ops** (Special Abilities focus)
- Stack: Orbital Strike, Colony Ship Barrage, Automated Defense
- Goal: Win fights with powerful activated abilities
- Synergy: Combat Scavenger generates powerups for sustainability

**5. Hybrid Fleet** (Balanced approach)
- Mix of exploration (fuel), combat (stats), and resources
- Most flexible and adaptable to any encounter
- Recommended for beginners

---

## Fleet Upgrade UI

### In-Run Display

**Fleet Upgrades Panel** (accessible from sector map):
```
┌──────────────────────────────────────┐
│   FLEET UPGRADES (12 Active)         │
├──────────────────────────────────────┤
│ Exploration (4):                     │
│  • Fuel Efficiency x2                │
│  • Enhanced Gravity Assist x1        │
│  • Extended Sensors x1               │
│                                      │
│ Combat (5):                          │
│  • Fleet Cohesion x3                 │
│  • Reinforced Fleet x2               │
│                                      │
│ Resources (2):                       │
│  • Mining Efficiency x2              │
│                                      │
│ Abilities (1):                       │
│  • Orbital Strike x1 (1/1 uses)      │
└──────────────────────────────────────┘
```

### Acquisition Choice UI

When earning a fleet upgrade from milestone:
```
┌──────────────────────────────────────┐
│   SECTOR CLEARED - CHOOSE UPGRADE    │
├──────────────────────────────────────┤
│  [Card 1]          [Card 2]          │
│  Fuel Efficiency   Fleet Cohesion    │
│  ★★☆☆☆ Common      ★★☆☆☆ Common      │
│                                      │
│  Jump: -1 fuel     All ships:        │
│  (Currently 10)    +5% Attack Speed  │
│  New: 9 fuel       (Currently +15%)  │
│                    New: +20%         │
│                                      │
│  Stacks: 2/∞       Stacks: 3/∞       │
└──────────────────────────────────────┘
```

---

## CSV Database Structure

### fleet_upgrades.csv

```csv
upgrade_id,upgrade_name,category,rarity,base_effect,stack_effect,max_stacks,description,acquisition_methods,cost_metal,cost_crystals
fuel_efficiency,Fuel Efficiency,exploration,common,jump_cost_-2,jump_cost_-1,5,"Optimized jump calculations","trader,milestone",150,75
enhanced_gravity,Enhanced Gravity Assist,exploration,common,gravity_bonus_0.3,gravity_bonus_0.1,∞,"Mastery of orbital mechanics","trader,vault",100,50
fleet_cohesion,Fleet Cohesion,combat,common,all_attack_speed_5,all_attack_speed_5,∞,"Synchronized firing protocols","trader,milestone",200,100
mining_efficiency,Mining Efficiency,resource,common,mining_yield_1.2,mining_yield_0.1,∞,"Enhanced extraction algorithms","trader",150,75
orbital_strike,Orbital Strike,ability,rare,orbital_uses_1,orbital_uses_1,∞,"Colony Ship weapons online","milestone,boss",500,250
advanced_logistics,Advanced Logistics,ability,legendary,relic_slots_7,none,1,"Expanded equipment hardpoints","boss",0,0
```

### Column Definitions

| Column | Type | Description |
|--------|------|-------------|
| `upgrade_id` | String | Unique identifier (e.g., "fuel_efficiency") |
| `upgrade_name` | String | Display name (e.g., "Fuel Efficiency") |
| `category` | String | Category: exploration, combat, resource, ability |
| `rarity` | String | Rarity tier: common, uncommon, rare, epic, legendary |
| `base_effect` | String | Effect code for first stack (e.g., "jump_cost_-2") |
| `stack_effect` | String | Effect code for additional stacks (e.g., "jump_cost_-1") |
| `max_stacks` | Integer/String | Maximum stacks (number or "∞" for unlimited) |
| `description` | String | Flavor text |
| `acquisition_methods` | String | Comma-separated: trader, vault, graveyard, milestone, boss |
| `cost_metal` | Integer | Purchase cost in Metal (0 if not purchasable) |
| `cost_crystals` | Integer | Purchase cost in Crystals (0 if not purchasable) |

---

## Implementation Notes

### FleetUpgradeManager Singleton

```gdscript
extends Node

# Active fleet upgrades (upgrade_id → stack_count)
var active_upgrades: Dictionary = {}

# Load upgrade definitions from CSV
var upgrade_data: Dictionary = {}

func _ready() -> void:
    upgrade_data = DataManager.fleet_upgrades
    EventBus.sector_entered.connect(_on_sector_entered)

func add_upgrade(upgrade_id: String) -> void:
    if not active_upgrades.has(upgrade_id):
        active_upgrades[upgrade_id] = 0

    var upgrade := upgrade_data[upgrade_id]
    var max_stacks: int = upgrade.get("max_stacks", 999)

    if active_upgrades[upgrade_id] < max_stacks:
        active_upgrades[upgrade_id] += 1
        _apply_upgrade_effect(upgrade_id)
        EventBus.fleet_upgrade_acquired.emit(upgrade_id, active_upgrades[upgrade_id])
    else:
        # Refund if at max stacks
        ResourceManager.add_metal(50, "duplicate_fleet_upgrade")
        ResourceManager.add_crystals(25, "duplicate_fleet_upgrade")

func get_total_bonus(stat_type: String) -> float:
    var total := 0.0
    for upgrade_id in active_upgrades.keys():
        var stacks := active_upgrades[upgrade_id]
        # Calculate bonus based on upgrade definition
        total += _calculate_upgrade_bonus(upgrade_id, stat_type, stacks)
    return total

func has_upgrade(upgrade_id: String) -> bool:
    return active_upgrades.has(upgrade_id) and active_upgrades[upgrade_id] > 0

func get_stack_count(upgrade_id: String) -> int:
    return active_upgrades.get(upgrade_id, 0)

func reset_upgrades() -> void:
    # Called when run ends (death or victory)
    active_upgrades.clear()
```

---

## Balance Considerations

### Diminishing Returns
- Additive stacking keeps each upgrade valuable (no exponential scaling)
- Percentage bonuses cap at reasonable levels (e.g., max +50% from one type)

### Opportunity Cost
- Fleet upgrades compete with relics/weapons for resources at traders
- Milestone rewards force choice between upgrades (can't get all)

### Power Budget
- **Common upgrades**: ~5-10% power increase per stack
- **Rare upgrades**: ~15-25% power increase (but harder to stack)
- **Legendary upgrades**: Game-changing but single-stack

### Early vs Late Game
- **Early**: Exploration upgrades more valuable (need fuel, sensors)
- **Mid**: Combat upgrades scale with fleet size
- **Late**: Special abilities become critical (Orbital Strike, Colony Ship Barrage)

---

## Future Expansion Ideas

### Synergy Upgrades
Fleet upgrades that interact with each other:
- **"Fleet Commander"**: If you have 3+ Combat upgrades, all combat upgrades are 20% more effective

### Conditional Upgrades
Upgrades with activation requirements:
- **"Last Stand"**: When below 30% fleet health, all ships gain +50% damage

### Sacrifice Upgrades
Powerful effects with drawbacks:
- **"Overclocked Reactor"**: +25% global attack speed, but -10% max Hull on all ships

---

## Conclusion

The **Fleet Upgrades System** provides strategic meta-progression within each run, allowing players to customize their fleet's capabilities beyond individual ship equipment. By offering exploration, combat, resource, and ability upgrades through multiple acquisition methods, players can adapt their strategy to each run's challenges and opportunities.

**Design Pillars**:
1. **Distinct from Relics**: Global effects vs. ship-specific equipment
2. **Strategic Choice**: Limited acquisition forces meaningful decisions
3. **Stackable Power**: Each upgrade remains valuable throughout the run
4. **Category Diversity**: Supports multiple playstyles (explorer, fighter, economist, specialist)

**CSV Files Needed**:
- `fleet_upgrades.csv` - All fleet upgrade definitions (~50-80 upgrades)
